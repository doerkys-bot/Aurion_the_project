<section id="vorhof-counter" style="text-align:center; margin:2em 0;">
  <div style="margin-bottom:0.8em; font-size:1.1em; color:#eee;">
    ðŸšª Besucher im Vorhof: 
    <strong id="count" style="color:#ffcc00;">â€“</strong>
  </div>
  <button id="host-toggle" 
          style="background:#222; color:#ffcc00; border:1px solid #ffcc00;
                 padding:0.6em 1.2em; border-radius:6px; cursor:pointer; font-size:0.9em;">
    Ich bin der Gastgeber (eigene Besuche nicht zÃ¤hlen)
  </button>
  <div id="host-hint" style="margin-top:0.6em; font-size:0.85em; color:#aaa;">
    Status: unbekannt
  </div>
</section>

<script>
  (function() {
    const NAMESPACE = 'auriontheproject.eu';
    const KEY = 'vorhof';
    const COUNT_API = `https://api.countapi.xyz`;
    const countEl = document.getElementById('count');
    const toggleBtn = document.getElementById('host-toggle');
    const hintEl = document.getElementById('host-hint');
    const HOST_KEY = 'aurion_host_exclude';

    const isHost = () => localStorage.getItem(HOST_KEY) === '1';
    const setHost = (v) => localStorage.setItem(HOST_KEY, v ? '1' : '0');

    function updateHostUI() {
      hintEl.textContent = 'Status: ' + (isHost()
        ? 'Gastgeber (eigene Besuche werden NICHT gezÃ¤hlt)'
        : 'Gast (Besuche werden gezÃ¤hlt)');
      toggleBtn.style.opacity = isHost() ? 0.7 : 1;
    }

    async function ensureCounter() {
      try {
        await fetch(`${COUNT_API}/create?namespace=${encodeURIComponent(NAMESPACE)}&key=${encodeURIComponent(KEY)}`);
      } catch (e) {}
    }

    async function getCount() {
      try {
        const r = await fetch(`${COUNT_API}/get/${encodeURIComponent(NAMESPACE)}/${encodeURIComponent(KEY)}`);
        const data = await r.json();
        countEl.textContent = (data && typeof data.value === 'number') ? data.value : 'â€“';
      } catch (e) {
        countEl.textContent = 'â€“';
      }
    }

    async function maybeIncrement() {
      if (isHost()) {
        await getCount();
        return;
      }
      try {
        const r = await fetch(`${COUNT_API}/hit/${encodeURIComponent(NAMESPACE)}/${encodeURIComponent(KEY)}`);
        const data = await r.json();
        countEl.textContent = (data && typeof data.value === 'number') ? data.value : 'â€“';
      } catch (e) {
        await getCount();
      }
    }

    toggleBtn.addEventListener('click', async function() {
      setHost(!isHost());
      updateHostUI();
      await getCount();
    });

    (async function init() {
      updateHostUI();
      await ensureCounter();
      await maybeIncrement();
    })();
  })();
</script>
